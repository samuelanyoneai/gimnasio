name: Security Scan

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Ejecutar anÃ¡lisis de seguridad diariamente a las 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  security-analysis:
    name: Deep Security Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: Configurar PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: pdo, pdo_pgsql
      
      - name: AnÃ¡lisis de vulnerabilidades con Snyk
        uses: snyk/actions/php@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high
      
      - name: Buscar secretos expuestos
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
        continue-on-error: true
      
      - name: AnÃ¡lisis de dependencias
        run: |
          if [ -f composer.json ]; then
            composer audit --format=json > security-audit.json || true
            if [ -f security-audit.json ]; then
              echo "ðŸ“Š Resultados del anÃ¡lisis de seguridad:"
              cat security-audit.json
            fi
          fi
      
      - name: Verificar configuraciÃ³n de seguridad
        run: |
          echo "ðŸ”’ Verificando configuraciÃ³n de seguridad..."
          
          # Verificar que no haya credenciales hardcodeadas
          if grep -r "password.*=.*['\"].*['\"]" --include="*.php" config/ | grep -v "//\|#"; then
            echo "âš ï¸ Posibles credenciales hardcodeadas encontradas"
            exit 1
          fi
          
          # Verificar uso de HTTPS en producciÃ³n
          echo "âœ… Verificaciones de seguridad completadas"
      
      - name: Generar reporte de seguridad
        run: |
          echo "# Reporte de Seguridad" > security-report.md
          echo "Fecha: $(date)" >> security-report.md
          echo "" >> security-report.md
          echo "## Verificaciones Realizadas" >> security-report.md
          echo "- âœ… AnÃ¡lisis de vulnerabilidades" >> security-report.md
          echo "- âœ… BÃºsqueda de secretos expuestos" >> security-report.md
          echo "- âœ… VerificaciÃ³n de dependencias" >> security-report.md
          echo "- âœ… VerificaciÃ³n de configuraciÃ³n" >> security-report.md
          cat security-report.md
      
      - name: Upload security report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-report.md

