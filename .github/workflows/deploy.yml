name: Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
      
      - name: Configurar PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: pdo, pdo_pgsql
      
      - name: Validar antes de deploy
        run: |
          echo "üîç Validando c√≥digo antes del deploy..."
          find . -name "*.php" -not -path "./vendor/*" -exec php -l {} \;
      
      - name: Crear paquete de deploy
        run: |
          echo "üì¶ Creando paquete de deploy..."
          
          # Verificar que los directorios existen
          echo "Verificando estructura del proyecto..."
          ls -la
          
          # Crear directorio de deploy
          mkdir -p deploy
          
          # Copiar directorios solo si existen
          [ -d "config" ] && cp -r config deploy/ || echo "‚ö†Ô∏è Directorio config no encontrado"
          [ -d "models" ] && cp -r models deploy/ || echo "‚ö†Ô∏è Directorio models no encontrado"
          [ -d "controllers" ] && cp -r controllers deploy/ || echo "‚ö†Ô∏è Directorio controllers no encontrado"
          [ -d "views" ] && cp -r views deploy/ || echo "‚ö†Ô∏è Directorio views no encontrado"
          [ -d "public" ] && cp -r public deploy/ || echo "‚ö†Ô∏è Directorio public no encontrado"
          [ -d "database" ] && cp -r database deploy/ || echo "‚ö†Ô∏è Directorio database no encontrado"
          
          # Verificar que se copiaron archivos
          if [ -z "$(ls -A deploy)" ]; then
            echo "‚ùå Error: No se copiaron archivos al directorio deploy"
            exit 1
          fi
          
          # Crear archivo tar
          tar -czf deploy.tar.gz deploy/
          echo "‚úÖ Paquete creado: deploy.tar.gz"
          
          # Mostrar contenido del paquete
          echo "Contenido del paquete:"
          tar -tzf deploy.tar.gz | head -20
      
      - name: Upload deployment package
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: deploy.tar.gz
          retention-days: 7
      
      - name: Deploy notification
        run: |
          echo "üöÄ Paquete de deploy listo"
          echo "El paquete est√° disponible en los artifacts de GitHub Actions"
          echo "Para desplegar manualmente, descarga deploy.tar.gz y extr√°elo en el servidor"

